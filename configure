#!/bin/sh

# Check for Rust toolchain per CRAN policy
echo "Checking for Rust toolchain..."

# Check for cargo in PATH and ~/.cargo/bin
CARGO_CMD=""
if command -v cargo >/dev/null 2>&1; then
  CARGO_CMD="cargo"
elif [ -f "$HOME/.cargo/bin/cargo" ]; then
  CARGO_CMD="$HOME/.cargo/bin/cargo"
fi

# Check for rustc in PATH and ~/.cargo/bin
RUSTC_CMD=""
if command -v rustc >/dev/null 2>&1; then
  RUSTC_CMD="rustc"
elif [ -f "$HOME/.cargo/bin/rustc" ]; then
  RUSTC_CMD="$HOME/.cargo/bin/rustc"
fi

if [ -z "$CARGO_CMD" ] || [ -z "$RUSTC_CMD" ]; then
  echo "ERROR: Rust toolchain not found"
  echo ""
  echo "This package requires Cargo and rustc (>= 1.56.0)"
  echo ""
  echo "Please install Rust via your system package manager:"
  echo "  Debian/Ubuntu: sudo apt-get install cargo rustc"
  echo "  Fedora/RHEL:   sudo dnf install cargo"
  echo "  macOS:         brew install rust"
  echo ""
  echo "Or install via rustup from https://rustup.rs/"
  exit 1
fi

# Check versions
CARGO_VERSION=$($CARGO_CMD --version | sed 's/cargo //')
RUSTC_VERSION=$($RUSTC_CMD --version | sed 's/rustc //')

echo "Found cargo: $CARGO_VERSION"
echo "Found rustc: $RUSTC_VERSION"

# Check if we need to create vendor directory
# This handles the case when installing from GitHub via remotes::install_github()
if [ ! -d "src/rust/vendor" ] && [ ! -f "src/rust/vendor.tar.xz" ]; then
  echo "Vendor directory not found. Creating vendor directory..."
  if [ -f "src/rust/update-vendor.sh" ]; then
    ./src/rust/update-vendor.sh
    echo "Vendor directory created successfully"
  else
    echo "Warning: update-vendor.sh not found. Cargo will fetch from crates.io"
  fi
fi

# Generate cargo config for vendored sources only if vendor/ exists
if [ -d "src/rust/vendor" ]; then
  mkdir -p src/rust/.cargo
  cat > src/rust/.cargo/config.toml << 'EOF'
[source.crates-io]
replace-with = "vendored-sources"

[source.vendored-sources]
directory = "vendor"
EOF
  echo "Cargo configuration created for vendored sources"
else
  echo "Note: vendor/ directory not found. Cargo will fetch from crates.io"
fi
