name: Cargo Update

on:
  schedule:
    # Run twice a month on the 1st and 15th at 00:00 UTC
    - cron: '0 0 1,15 * *'
  workflow_dispatch: # Allow manual triggers

jobs:
  cargo-update:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      actions: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Update Cargo.lock
        id: cargo_update
        run: |
          cd src/rust
          cargo update
          if git diff --quiet Cargo.lock; then
            echo "No cargo updates available"
            echo "cargo_updated=false" >> $GITHUB_OUTPUT
          else
            echo "Cargo.lock has been updated"
            echo "cargo_updated=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Vendor Rust dependencies
        run: ./src/rust/update-vendor.sh
      
      - name: Create Pull Request
        if: steps.cargo_update.outputs.cargo_updated == 'true'
        id: create_pr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update Cargo.lock dependencies'
          title: 'chore: update Cargo.lock dependencies'
          body: |
            This PR updates Rust dependencies.
            
            This is an automated PR created by the cargo-update workflow.
            
            Please review the changes and merge if appropriate.
            
            After merging, remember to run `./src/rust/update-vendor.sh` to update
            the vendored dependencies for the next CRAN release.
          branch: cargo-update-${{ github.run_number }}
          delete-branch: true
      
      - name: Trigger R-CMD-check on PR branch
        if: steps.cargo_update.outputs.cargo_updated == 'true' && steps.create_pr.outputs.pull-request-number != ''
        run: |
          gh workflow run R-CMD-check.yaml --ref cargo-update-${{ github.run_number }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
