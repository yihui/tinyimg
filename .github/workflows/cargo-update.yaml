name: Cargo Update and Benchmark

on:
  schedule:
    # Run twice a month on the 1st and 15th at 00:00 UTC
    - cron: '0 0 1,15 * *'
  workflow_dispatch: # Allow manual triggers

jobs:
  cargo-update:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Update Cargo.lock
        id: cargo_update
        run: |
          cd src/rust
          cargo update
          if git diff --quiet Cargo.lock; then
            echo "No cargo updates available"
            echo "cargo_updated=false" >> $GITHUB_OUTPUT
          else
            echo "Cargo.lock has been updated"
            echo "cargo_updated=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Vendor Rust dependencies
        run: ./src/rust/update-vendor.sh
      
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
      
      - name: Install R dependencies
        run: |
          Rscript -e "install.packages('testit', repos='https://cloud.r-project.org')"
      
      - name: Install package
        run: |
          R CMD build .
          sudo R CMD INSTALL tinyimg_*.tar.gz
      
      - name: Run benchmarks
        id: benchmark
        run: |
          cd benchmarks
          Rscript benchmark-levels.R
          cd ..
          if git diff --quiet benchmarks/; then
            echo "No benchmark changes"
            echo "benchmark_updated=false" >> $GITHUB_OUTPUT
          else
            echo "Benchmarks have been updated"
            echo "benchmark_updated=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Pull Request
        if: steps.cargo_update.outputs.cargo_updated == 'true' || steps.benchmark.outputs.benchmark_updated == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update dependencies and benchmarks'
          title: 'chore: update Cargo.lock dependencies and benchmarks'
          body: |
            This PR updates Rust dependencies and regenerates benchmarks.
            
            **Changes:**
            - Cargo dependencies updated: ${{ steps.cargo_update.outputs.cargo_updated }}
            - Benchmarks updated: ${{ steps.benchmark.outputs.benchmark_updated }}
            
            This is an automated PR created by the cargo-update workflow.
            
            Please review the changes and merge if appropriate.
            
            After merging, remember to run `./src/rust/update-vendor.sh` to update
            the vendored dependencies for the next CRAN release if cargo was updated.
          branch: cargo-update-${{ github.run_number }}
          delete-branch: true
