# tinyimg - Repository Instructions for Copilot

## Repository Overview

This is an R package that optimizes and compresses images using Rust libraries. The package currently supports PNG optimization via the [oxipng](https://github.com/shssoichiro/oxipng) Rust crate.

**Project Type**: R package with Rust backend (hybrid R/Rust codebase)
**Languages**: R, Rust, C (for FFI)
**Size**: Small repository (~15 files excluding vendor dependencies)
**Target Runtime**: R (>= 3.5.0) with Rust/Cargo (>= 1.56.0)

## Build and Test Instructions

### Prerequisites

**Note**: Rust and R are automatically installed via `.github/copilot-setup-steps.yml` when working with GitHub Copilot. For manual setup:
- R (>= 3.5.0) - available via `copilot-setup-steps.yml`
- Rust/Cargo (>= 1.56.0) - available via `copilot-setup-steps.yml`
- R package dependencies (testit, roxygen2) - available via `copilot-setup-steps.yml`

**For testing on Linux manually**: If not using Copilot's automated setup, install the latest R from CRAN, not from Debian/Ubuntu official repositories. Follow instructions at https://cran.r-project.org/bin/linux/ubuntu to ensure you're testing with the most recent R version that users will have.

### Bootstrap and Build Sequence

**Important**: Always run commands in this exact order to avoid build failures.

1. **Vendor Rust dependencies** (required before building):
   ```bash
   ./src/rust/update-vendor.sh
   ```
   - Creates `vendor/` directory with Rust dependencies
   - Creates `vendor.tar.xz` compressed archive
   - Takes ~30-60 seconds depending on network speed
   - Must be run at least once before building

2. **Build the R package**:
   ```bash
   R CMD build .
   ```
   - Creates a `.tar.gz` package file
   - Takes ~1-2 minutes (includes Rust compilation)

3. **Install the package**:
   ```bash
   R CMD INSTALL tinyimg_*.tar.gz
   ```
   or from source:
   ```bash
   R CMD INSTALL .
   ```

4. **Run tests**:
   ```bash
   R CMD check tinyimg_*.tar.gz
   ```
   or directly:
   ```bash
   Rscript tests/test-all.R
   ```
   - Tests use the `testit` package
   - All tests should pass without errors

### Testing Conventions

- Tests are in `tests/test-all.R`
- Use `testit` package for assertions
- Always wrap test conditions in `{}`: `assert('message', {})`
- Use `has_error()` instead of `tryCatch()` for error testing
- Load the package with `library(tinyimg)` before testing

### Common Build Issues and Solutions

1. **"Vendor directory not found"**: Run `./src/rust/update-vendor.sh` first
2. **Rust compiler not found**: Should not occur when using Copilot (installed via `copilot-setup-steps.yml`). For manual setup, install Rust from https://rustup.rs/
3. **"abort() warning" in R CMD check**: This is from Rust std library and is handled by `PKG_CFLAGS = $(C_VISIBILITY)` in `src/Makevars`
4. **Cargo checksum errors**: Do NOT manually delete files from `vendor/` directory after running `update-vendor.sh`

## Project Structure

### Key Files and Directories

**Root level**:
- `DESCRIPTION` - R package metadata
- `NAMESPACE` - R package namespace (auto-generated by roxygen2)
- `configure` - Shell script that sets up cargo config for vendored sources
- `README.md` - Package documentation

**R code** (`R/`):
- `tinypng.R` - Main user-facing function
- `extendr-wrappers.R` - Auto-generated R wrappers for Rust functions
- `tinyimg-package.R` - Package documentation

**Rust code** (`src/rust/`):
- `Cargo.toml` - Rust package manifest
- `Cargo.lock` - Locked dependency versions
- `src/lib.rs` - Main Rust library code
- `update-vendor.sh` - Script to vendor and compress Rust dependencies
- `vendor/` - Vendored Rust dependencies (gitignored, created by update-vendor.sh)
- `vendor.tar.xz` - Compressed archive for CRAN releases (gitignored)

**C FFI** (`src/`):
- `entrypoint.c` - R entry point with symbol visibility attributes
- `Makevars` - Build configuration for Unix-like systems
- `Makevars.win` - Build configuration for Windows

**Tests** (`tests/`):
- `test-all.R` - All package tests using testit framework

### CI/CD Configuration

**GitHub Actions** (`.github/workflows/`):
- `R-CMD-check.yaml` - Runs R CMD check on multiple platforms (Ubuntu, macOS, Windows) with R release/devel
- `cargo-update.yaml` - Automated dependency updates

**Critical CI Steps**:
1. Set up Rust toolchain
2. **Run `./src/rust/update-vendor.sh`** (required before R CMD build)
3. Set up R
4. Install dependencies
5. Run R CMD check

## Key Technical Details

### Rust/R Integration

- Uses `extendr` framework for Rust/R interop
- Rust code is compiled to a static library (`libtinyimg.a`)
- Linked into R shared library (`.so`/`.dll`)
- Symbol visibility controlled by `PKG_CFLAGS = $(C_VISIBILITY)` in Makevars

### Vendor Directory Management

**Important**: The vendor directory workflow follows the [gifski](https://github.com/r-rust/gifski) pattern:

- `vendor/` and `vendor.tar.xz` are both gitignored
- `update-vendor.sh` creates both the directory and compressed archive
- For development: Keep `vendor/` directory
- For CRAN releases: Include `vendor.tar.xz` in package tarball
- Never commit vendor files to git
- Never manually delete files from vendor/ - this breaks cargo checksums

### Makevars Details

`src/Makevars` (Unix/macOS):
- `PKG_CFLAGS = -pthread $(C_VISIBILITY)` - Sets symbol visibility
- `PKG_LIBS = -L$(LIBDIR) -ltinyimg` - Links Rust static library
- `cleanup` target removes static library after linking (prevents R CMD check warnings)
- Extracts `vendor.tar.xz` if present before cargo build

### Configure Script

The `configure` script at package root:
- Checks if vendor directory exists
- If missing and Rust is available, runs `update-vendor.sh`
- Generates `.cargo/config.toml` to use vendored sources
- Enables `remotes::install_github()` to work automatically

## Validation Steps

Before submitting changes:

1. Run `./src/rust/update-vendor.sh` if Rust dependencies changed
2. Run `R CMD build .` to build package
3. Run `R CMD check tinyimg_*.tar.gz` to validate
4. Ensure all tests pass: `Rscript tests/test-all.R`
5. Check GitHub Actions status for multi-platform validation

## Important Conventions

### R Code Style

1. **Assignment**: Use `=` instead of `<-` for assignment
2. **Indentation**: Use 2 spaces (not 4 spaces or tabs)
3. **Compact code**: Avoid `{}` for single-expression if statements; prefer compact forms when possible
4. **Roxygen documentation**: Don't use `@description` or `@details` explicitly - just write the description text directly after the title
5. **Examples**: Avoid `\dontrun{}` unless absolutely necessary (e.g., requires external resources, takes very long time, or has side effects that could harm user's system). Prefer runnable examples that can be tested automatically.
6. **Function definitions**: For functions with many arguments, break the line right after the opening `(`, indent arguments by 2 spaces, and try to wrap them at 80-char width, e.g.:
   ```r
   f = function(
     arg1, arg2, ...,
     argN, ...
   ) {
     ...
   }
   ```
7. **Re-wrap code**: Always re-wrap the code after making changes to maintain consistent formatting and line length.

### Testing Conventions

1. **Use testit properly**: Write all test conditions in `()`, use `%==%` to test for `identical()`, and test conditions can return vectors (if all elements are TRUE, the test passes). Use `L` suffix for integer literals when comparing lengths.
   ```r
   assert("test description", {
     (length(result) %==% 3L)
     (file.exists(result))
   })
   ```

### Build and Package Conventions

1. **Always re-roxygenize**: Run `roxygen2::roxygenize()` after changing any roxygen documentation to update man files
2. **MANDATORY: R CMD check before EVERY commit**: You MUST run `R CMD check` successfully before submitting ANY code changes. If R or required R packages are not available, you MUST install them first using `sudo apt-get install r-base` and `Rscript -e "install.packages(...)"`. There are NO exceptions to this rule.
3. **MANDATORY: Wait for CI to be green**: After pushing code, you MUST wait for GitHub Actions CI to complete successfully before claiming the task is done. Never quit while CI is running or failing.
4. **Bump version in PRs**: Bump the patch version number in DESCRIPTION once per PR (on the first commit or when you first make changes), not on every commit to the PR
5. **NEVER BREAK CI**: Breaking CI is completely unacceptable. If CI fails, you must immediately fix it. This policy must be followed strictly for ALL changes without exception.
6. **Never commit vendor files**: Both `vendor/` and `vendor.tar.xz` are gitignored
7. **Never commit binary files**: Avoid version-controlling binary files, especially automatically generated ones (they can be hosted on a website, but not in GIT)
8. **Symbol visibility**: Always use `$(C_VISIBILITY)` in Makevars
9. **Testing**: Use testit assertions with proper error handling
10. **Dependencies**: Run cargo vendor after any Cargo.toml changes
11. **Cross-platform**: Test on Linux, macOS, and Windows via CI

## Package API

Main function:
```r
tinypng(input, output = input, level = 2L)
```
- `input`: Path to input PNG file
- `output`: Path to output PNG file (defaults to overwrite input)
- `level`: Optimization level 0-6 (0=fast, 6=maximum compression, default=2)

## Additional Resources

- Package follows CRAN R package standards
- Rust integration follows r-rust community best practices
- See gifski package for similar Rust/R integration example: https://github.com/r-rust/gifski
