# tinyimg

[![R-CMD-check](https://github.com/yihui/tinyimg/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/yihui/tinyimg/actions/workflows/R-CMD-check.yaml)

An R package for optimizing and compressing images using Rust libraries. Currently supports PNG optimization via the [oxipng](https://github.com/shssoichiro/oxipng) crate.

## Installation

You can install the development version of tinyimg from GitHub:

```r
# install.packages("remotes")
remotes::install_github("yihui/tinyimg")
```

## Requirements

- R (>= 3.5.0)
- Rust/Cargo (>= 1.56.0)

The package includes vendored Rust dependencies per CRAN policy, so you don't need internet access during installation.

## Usage

### Basic PNG optimization

```r
library(tinyimg)

# Create a test PNG
tmp = tempfile(fileext = ".png")
png(tmp, width = 400, height = 400)
plot(1:10)
dev.off()

# Optimize with different levels
optim_png(tmp, paste0(tmp, "-o1.png"), level = 1)
optim_png(tmp, paste0(tmp, "-o6.png"), level = 6)

# Strip metadata for smaller files
optim_png(tmp, paste0(tmp, "-stripped.png"), strip = "safe")

# Optimize transparent images
optim_png(tmp, paste0(tmp, "-alpha.png"), alpha = TRUE)

# Set timeout for large files
optim_png(tmp, paste0(tmp, "-fast.png"), timeout = 5)
```

### Directory optimization

```r
# Optimize all PNGs in a directory
optim_png("path/to/directory")

# Optimize recursively (including subdirectories)
optim_png("path/to/directory", recursive = TRUE)

# Optimize to a different directory
optim_png("input_dir", "output_dir")
```

### Optimization levels

The `level` parameter controls the optimization level (0-6):

- `0`: Fast optimization with minimal compression (~3-17% reduction)
- `2`: Default - good balance between speed and compression (~22-29% reduction)
- `6`: Maximum optimization - best compression but slower (~24-29% reduction)

See [benchmarks/](benchmarks/) for detailed performance metrics.

### Advanced options

- **strip**: Strip metadata chunks (`"safe"` or `"all"`)
- **alpha**: Optimize transparent pixels (visually lossless)
- **interlace**: Control interlacing (`"off"`, `"on"`, or `"keep"`)
- **fast**: Use fast compression evaluation
- **preserve**: Preserve file permissions and timestamps (default: `TRUE`)
- **timeout**: Maximum optimization time in seconds (0 = no limit)
- **recursive**: Process subdirectories when optimizing directories

See `?optim_png` for full documentation.

## Benchmarks

Performance benchmarks are automatically generated twice monthly. See [benchmarks/README.md](benchmarks/README.md) for details.

Quick summary (from latest benchmarks):
- Simple plots: 12ms (level 0) to 1.6s (level 6)
- Complex plots: 35ms (level 0) to 5.5s (level 6)
- Compression: 3-29% file size reduction depending on level

## For Package Developers

### Building from GitHub

When installing from GitHub via `remotes::install_github("yihui/tinyimg")`, the package will automatically create the vendor directory if Rust is installed on your system. No manual intervention is required!

If you're developing and need to manually create the vendor directory:

```bash
# Run the update script to create vendor/ directory
./src/rust/update-vendor.sh
```

This creates the local `vendor/` directory needed for development. Neither `vendor/` nor `vendor.tar.xz` are tracked in git (following the [gifski](https://github.com/r-rust/gifski) approach).

### CRAN Release Workflow

1. Wait for or merge any pending dependency update PRs from the automated workflow
2. Run `./src/rust/update-vendor.sh` to create `vendor.tar.xz`
3. Build the R package with `R CMD build` (includes `vendor.tar.xz`)
4. The CRAN tarball contains `vendor.tar.xz`, not the uncompressed `vendor/` directory
5. During installation, Makevars extracts `vendor.tar.xz` if present

Note: The `.cargo/config.toml` file is automatically generated by the `configure` script.

## License

MIT License. See LICENSE file for details.
