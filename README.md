# tinyimg

[![R-CMD-check](https://github.com/yihui/tinyimg/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/yihui/tinyimg/actions/workflows/R-CMD-check.yaml)

An R package for optimizing and compressing images using Rust libraries. Currently supports PNG optimization via the [oxipng](https://github.com/shssoichiro/oxipng) crate.

## Installation

You can install the development version of tinyimg from GitHub:

```r
# install.packages("remotes")
remotes::install_github("yihui/tinyimg")
```

## Requirements

- R (>= 3.5.0)
- Rust/Cargo (>= 1.56.0)

The package includes vendored Rust dependencies per CRAN policy, so you don't need internet access during installation.

## Usage

### Basic PNG optimization

```r
library(tinyimg)

# Optimize a PNG file in-place (overwrites the original)
optim_png("path/to/image.png")

# Optimize and save to a different file
optim_png("input.png", "output.png")

# Use maximum optimization (slower but better compression)
optim_png("image.png", level = 6)

# Use fast optimization
optim_png("image.png", level = 0)
```

### Optimization levels

The `level` parameter controls the optimization level (0-6):

- `0`: Fast optimization with minimal compression
- `2`: Default - good balance between speed and compression
- `6`: Maximum optimization - best compression but slower

## For Package Developers

### Building from GitHub

When installing from GitHub via `remotes::install_github("yihui/tinyimg")`, the package will automatically create the vendor directory if Rust is installed on your system. No manual intervention is required!

If you're developing and need to manually create the vendor directory:

```bash
# Run the update script to create vendor/ directory
cd src/rust
./update-vendor.sh
```

This creates the local `vendor/` directory needed for development. Neither `vendor/` nor `vendor.tar.xz` are tracked in git (following the [gifski](https://github.com/r-rust/gifski) approach).

### Updating Vendored Dependencies

To update vendored dependencies for a CRAN release:

```bash
cd src/rust
./update-vendor.sh
```

This script will:
1. Vendor all dependencies into `vendor/`
2. Create compressed `vendor.tar.xz` archive

**Note:** The script no longer runs `cargo update`. Dependency updates are now managed through automated PRs created by a GitHub Actions cron job that runs twice monthly.

### CRAN Release Workflow

1. Wait for or merge any pending dependency update PRs from the automated workflow
2. Run `cd src/rust && ./update-vendor.sh` to create `vendor.tar.xz`
3. Build the R package with `R CMD build` (includes `vendor.tar.xz`)
4. The CRAN tarball contains `vendor.tar.xz`, not the uncompressed `vendor/` directory
5. During installation, Makevars extracts `vendor.tar.xz` if present

Note: The `.cargo/config.toml` file is automatically generated by the `configure` script.

## License

MIT License. See LICENSE file for details.
