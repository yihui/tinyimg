# Development Guide for optimg

This document provides detailed information for developers working on the optimg package.

## Package Structure

```
optimg/
├── DESCRIPTION              # Package metadata
├── NAMESPACE               # Exported functions (auto-generated)
├── LICENSE                 # MIT license
├── README.md              # User-facing documentation
├── .Rbuildignore          # Files to exclude from R package
├── .gitignore             # Files to exclude from git
├── update-vendor.sh       # Script to update vendored Rust dependencies
│
├── R/                     # R source code
│   ├── optimg-package.R   # Package-level documentation
│   ├── optim_png.R        # Main PNG optimization function
│   └── extendr-wrappers.R # Auto-generated Rust bindings
│
├── man/                   # Documentation (generated by roxygen2)
│   ├── optimg-package.Rd  # Package documentation
│   └── optim_png.Rd       # Function documentation
│
├── src/                   # C and Rust source code
│   ├── entrypoint.c       # C entry point for R
│   ├── Makevars           # Build configuration (Unix/Linux/macOS)
│   ├── Makevars.win       # Build configuration (Windows)
│   └── rust/              # Rust code
│       ├── Cargo.toml     # Rust dependencies
│       ├── Cargo.lock     # Locked dependency versions
│       ├── .cargo/
│       │   └── config.toml # Cargo config to use vendored sources
│       ├── src/
│       │   └── lib.rs     # Rust implementation
│       └── vendor/        # Vendored Rust dependencies (for CRAN)
│
├── tests/                 # Tests
│   └── test-all.R         # Test suite using testit
│
└── .github/
    └── workflows/
        └── R-CMD-check.yaml # CI workflow for R CMD check
```

## Development Workflow

### 1. Making Changes to R Code

When modifying R code:

1. Edit the R files in `R/`
2. Update roxygen2 comments (using markdown syntax)
3. Regenerate documentation:
   ```r
   roxygen2::roxygenise()
   # or
   devtools::document()
   ```

### 2. Making Changes to Rust Code

When modifying Rust code:

1. Edit `src/rust/src/lib.rs`
2. Test locally:
   ```bash
   cd src/rust
   cargo build --lib --release
   cargo test
   ```
3. If adding new Rust functions, update `R/extendr-wrappers.R` accordingly

### 3. Updating Rust Dependencies

To update vendored Rust dependencies:

```bash
# Using the provided script (recommended)
./update-vendor.sh

# Or manually:
cd src/rust
rm -rf vendor
cargo update
cargo vendor

# Then trim non-essential files (see update-vendor.sh for the full list):
find vendor -name ".github" -type d -exec rm -rf {} + 2>/dev/null || true
find vendor -name ".cargo" -type d -exec rm -rf {} + 2>/dev/null || true
find vendor -name "README*" -type f -delete 2>/dev/null || true
find vendor -name "benches" -type d -exec rm -rf {} + 2>/dev/null || true
find vendor -name "examples" -type d -exec rm -rf {} + 2>/dev/null || true
find vendor -name "tests" -type d -exec rm -rf {} + 2>/dev/null || true
# ... etc
```

**Important**: 
- After updating dependencies, test the package thoroughly and commit all changes including the `vendor/` directory. 
- The trimming process removes non-essential files to keep the package size small for CRAN.
- The `.cargo/config.toml` file is automatically generated by the `configure` script during package installation.

### 4. Adding New Dependencies

When adding new Rust crates:

1. Edit `src/rust/Cargo.toml`
2. Add the dependency
3. Run `cargo update`
4. Re-vendor with `./update-vendor.sh`
5. Commit all changes

## Testing

### Running Tests Locally

```r
# Load the package
devtools::load_all()

# Run tests
library(testit)
source("tests/test-all.R")
```

### Writing Tests

The package uses `testit` for testing. Add tests to `tests/test-all.R`:

```r
library(testit)

assert("description of test", {
  # test code
  result = optim_png(test_file)
  file.exists(result)
})
```

## Documentation

### roxygen2 with Markdown

The package uses roxygen2 with markdown support enabled. Key features:

- Use `**bold**` for bold text
- Use `*italic*` for italic text
- Use backticks for code: `` `code` ``
- Use `@details` for detailed information
- Use `@examples` for usage examples

Example:

```r
#' Function title
#'
#' Function description with **bold** and *italic* text.
#'
#' @param x Description with `code` formatting
#' @return Return value description
#'
#' @details
#' Detailed information with:
#' 
#' - Bullet points
#' - Multiple items
#'
#' @export
#' @examples
#' \dontrun{
#' my_function(x)
#' }
my_function = function(x) { ... }
```

## Building and Checking

### Local Build

```r
devtools::build()
```

### R CMD check

```r
devtools::check()
```

### Install Locally

```r
devtools::install()
```

## CRAN Submission Checklist

Before submitting to CRAN:

1. ✓ All Rust dependencies are vendored in `src/rust/vendor/`
2. ✓ Run `R CMD check` with no errors, warnings, or notes
3. ✓ Update version number in DESCRIPTION
4. ✓ Update NEWS.md with changes
5. ✓ Check documentation is up to date
6. ✓ All tests pass
7. ✓ GitHub Actions CI passes
8. ✓ Check package size (CRAN has limits)

## Coding Style

### R Code

- Use `=` for assignment (not `<-`)
- Follow standard R formatting conventions
- Document all exported functions with roxygen2
- Use meaningful variable names

### Rust Code

- Follow Rust standard style (use `cargo fmt`)
- Add comments for complex logic
- Handle errors appropriately
- Keep functions focused and small

## Continuous Integration

The package uses GitHub Actions for CI:

- **R-CMD-check.yaml**: Runs R CMD check on multiple platforms (Ubuntu, macOS, Windows) and R versions (release, devel)

CI automatically runs on:
- Push to main/master branches
- Pull requests to main/master branches

## Troubleshooting

### Build Errors

**Problem**: Rust compilation fails
- Solution: Check Rust version (>= 1.56.0)
- Solution: Ensure cargo is in PATH
- Solution: Check vendored dependencies are present

**Problem**: R CMD check fails
- Solution: Run `devtools::document()` to update documentation
- Solution: Check DESCRIPTION file is valid
- Solution: Ensure all dependencies are listed

### Common Issues

1. **Missing .cargo/config.toml**: This file is required to use vendored sources
2. **Old Cargo.lock**: Run `cargo update` if dependencies are outdated
3. **Platform-specific issues**: Check both Makevars and Makevars.win are correct

## Resources

- [rextendr documentation](https://extendr.github.io/rextendr/)
- [oxipng crate](https://github.com/shssoichiro/oxipng)
- [R Packages book](https://r-pkgs.org/)
- [roxygen2 documentation](https://roxygen2.r-lib.org/)
- [Writing R Extensions](https://cran.r-project.org/doc/manuals/r-release/R-exts.html)
